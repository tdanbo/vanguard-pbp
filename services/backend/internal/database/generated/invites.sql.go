// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: invites.sql

package generated

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const countActiveCampaignInvites = `-- name: CountActiveCampaignInvites :one
SELECT COUNT(*) FROM invite_links
WHERE campaign_id = $1
  AND used_at IS NULL
  AND revoked_at IS NULL
  AND expires_at > NOW()
`

func (q *Queries) CountActiveCampaignInvites(ctx context.Context, campaignID pgtype.UUID) (int64, error) {
	row := q.db.QueryRow(ctx, countActiveCampaignInvites, campaignID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createInviteLink = `-- name: CreateInviteLink :one
INSERT INTO invite_links (
    campaign_id,
    code,
    created_by,
    expires_at
) VALUES (
    $1, $2, $3, $4
)
RETURNING id, campaign_id, code, created_by, expires_at, used_at, used_by, revoked_at, created_at
`

type CreateInviteLinkParams struct {
	CampaignID pgtype.UUID        `json:"campaign_id"`
	Code       string             `json:"code"`
	CreatedBy  pgtype.UUID        `json:"created_by"`
	ExpiresAt  pgtype.Timestamptz `json:"expires_at"`
}

func (q *Queries) CreateInviteLink(ctx context.Context, arg CreateInviteLinkParams) (InviteLink, error) {
	row := q.db.QueryRow(ctx, createInviteLink,
		arg.CampaignID,
		arg.Code,
		arg.CreatedBy,
		arg.ExpiresAt,
	)
	var i InviteLink
	err := row.Scan(
		&i.ID,
		&i.CampaignID,
		&i.Code,
		&i.CreatedBy,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.UsedBy,
		&i.RevokedAt,
		&i.CreatedAt,
	)
	return i, err
}

const getInviteLinkByCode = `-- name: GetInviteLinkByCode :one
SELECT
    il.id, il.campaign_id, il.code, il.created_by, il.expires_at, il.used_at, il.used_by, il.revoked_at, il.created_at,
    c.title as campaign_title,
    c.owner_id as campaign_owner_id
FROM invite_links il
INNER JOIN campaigns c ON il.campaign_id = c.id
WHERE il.code = $1
`

type GetInviteLinkByCodeRow struct {
	ID              pgtype.UUID        `json:"id"`
	CampaignID      pgtype.UUID        `json:"campaign_id"`
	Code            string             `json:"code"`
	CreatedBy       pgtype.UUID        `json:"created_by"`
	ExpiresAt       pgtype.Timestamptz `json:"expires_at"`
	UsedAt          pgtype.Timestamptz `json:"used_at"`
	UsedBy          pgtype.UUID        `json:"used_by"`
	RevokedAt       pgtype.Timestamptz `json:"revoked_at"`
	CreatedAt       pgtype.Timestamptz `json:"created_at"`
	CampaignTitle   string             `json:"campaign_title"`
	CampaignOwnerID pgtype.UUID        `json:"campaign_owner_id"`
}

func (q *Queries) GetInviteLinkByCode(ctx context.Context, code string) (GetInviteLinkByCodeRow, error) {
	row := q.db.QueryRow(ctx, getInviteLinkByCode, code)
	var i GetInviteLinkByCodeRow
	err := row.Scan(
		&i.ID,
		&i.CampaignID,
		&i.Code,
		&i.CreatedBy,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.UsedBy,
		&i.RevokedAt,
		&i.CreatedAt,
		&i.CampaignTitle,
		&i.CampaignOwnerID,
	)
	return i, err
}

const listCampaignInvites = `-- name: ListCampaignInvites :many
SELECT id, campaign_id, code, created_by, expires_at, used_at, used_by, revoked_at, created_at FROM invite_links
WHERE campaign_id = $1
ORDER BY created_at DESC
`

func (q *Queries) ListCampaignInvites(ctx context.Context, campaignID pgtype.UUID) ([]InviteLink, error) {
	rows, err := q.db.Query(ctx, listCampaignInvites, campaignID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []InviteLink
	for rows.Next() {
		var i InviteLink
		if err := rows.Scan(
			&i.ID,
			&i.CampaignID,
			&i.Code,
			&i.CreatedBy,
			&i.ExpiresAt,
			&i.UsedAt,
			&i.UsedBy,
			&i.RevokedAt,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const markInviteUsed = `-- name: MarkInviteUsed :one
UPDATE invite_links
SET
    used_at = NOW(),
    used_by = $2
WHERE id = $1
RETURNING id, campaign_id, code, created_by, expires_at, used_at, used_by, revoked_at, created_at
`

type MarkInviteUsedParams struct {
	ID     pgtype.UUID `json:"id"`
	UsedBy pgtype.UUID `json:"used_by"`
}

func (q *Queries) MarkInviteUsed(ctx context.Context, arg MarkInviteUsedParams) (InviteLink, error) {
	row := q.db.QueryRow(ctx, markInviteUsed, arg.ID, arg.UsedBy)
	var i InviteLink
	err := row.Scan(
		&i.ID,
		&i.CampaignID,
		&i.Code,
		&i.CreatedBy,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.UsedBy,
		&i.RevokedAt,
		&i.CreatedAt,
	)
	return i, err
}

const revokeInvite = `-- name: RevokeInvite :one
UPDATE invite_links
SET revoked_at = NOW()
WHERE id = $1 AND campaign_id = $2
RETURNING id, campaign_id, code, created_by, expires_at, used_at, used_by, revoked_at, created_at
`

type RevokeInviteParams struct {
	ID         pgtype.UUID `json:"id"`
	CampaignID pgtype.UUID `json:"campaign_id"`
}

func (q *Queries) RevokeInvite(ctx context.Context, arg RevokeInviteParams) (InviteLink, error) {
	row := q.db.QueryRow(ctx, revokeInvite, arg.ID, arg.CampaignID)
	var i InviteLink
	err := row.Scan(
		&i.ID,
		&i.CampaignID,
		&i.Code,
		&i.CreatedBy,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.UsedBy,
		&i.RevokedAt,
		&i.CreatedAt,
	)
	return i, err
}
